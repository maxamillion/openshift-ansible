# Create/Delete network and firewall rules based on oo_network_state
#
# We have to parameterize Create/Destroy tasks because you can't delete a
# network with rules currently assigned becuase it considers it "in use"
- name: Create network
  gce_net:
    service_account_email: "{{ gce_service_account_email }}"
    pem_file: "{{ gce_pem_file }}"
    project_id: "{{ gce_project_id }}"
    name: "{{ oo_network }}"
    ipv4_range: "{{ oo_network_range }}"
    state: "{{ oo_network_state }}"
  when: oo_network_state == "present"

#- name: Configure firewall rule - Allow Internal TCP - "{{ oo_network_state }}"
#  gce_net:
#    service_account_email: "{{ gce_service_account_email }}"
#    pem_file: "{{ gce_pem_file }}"
#    project_id: "{{ gce_project_id }}"
#    name: "{{ oo_network }}"
#    fwname: "{{ oo_network }}-allow-internal"
#    src_range: "{{ oo_network_range }}"
#    allowed: 'tcp:1-65535'
#    state: "{{ oo_network_state }}"
#
#- name: Configure firewall rule - Allow Internal UDP - "{{ oo_network_state }}"
#  gce_net:
#    service_account_email: "{{ gce_service_account_email }}"
#    pem_file: "{{ gce_pem_file }}"
#    project_id: "{{ gce_project_id }}"
#    name: "{{ oo_network }}"
#    fwname: "{{ oo_network }}-allow-internal"
#    src_range: "{{ oo_network_range }}"
#    allowed: 'udp:1-65535'
#    state: "{{ oo_network_state }}"
#
#- name: Configure firewall rule - Allow Internal ICMP - "{{ oo_network_state }}"
#  gce_net:
#    service_account_email: "{{ gce_service_account_email }}"
#    pem_file: "{{ gce_pem_file }}"
#    project_id: "{{ gce_project_id }}"
#    name: "{{ oo_network }}"
#    fwname: "{{ oo_network }}-allow-internal"
#    src_range: "{{ oo_network_range }}"
#    allowed: 'tcp:1-65535'
#    state: "{{ oo_network_state }}"

- name: Configure firewall rule - Allow SSH - "{{ oo_network_state }}"
  gce_net:
    service_account_email: "{{ gce_service_account_email }}"
    pem_file: "{{ gce_pem_file }}"
    project_id: "{{ gce_project_id }}"
    name: "{{ oo_network }}"
    fwname: "{{ oo_network }}-allow-ssh"
    allowed: "tcp:22"
    state: "{{ oo_network_state }}"

- name: Configure firewall rule - Allow HTTP - "{{ oo_network_state }}"
  gce_net:
    service_account_email: "{{ gce_service_account_email }}"
    pem_file: "{{ gce_pem_file }}"
    project_id: "{{ gce_project_id }}"
    name: "{{ oo_network }}"
    fwname: "{{ oo_network }}-allow-http"
    allowed: "tcp:80"
    state: "{{ oo_network_state }}"

- name: Configure firewall rule - Allow HTTPS - "{{ oo_network_state }}"
  gce_net:
    service_account_email: "{{ gce_service_account_email }}"
    pem_file: "{{ gce_pem_file }}"
    project_id: "{{ gce_project_id }}"
    name: "{{ oo_network }}"
    fwname: "{{ oo_network }}-allow-https"
    allowed: "tcp:443"
    state: "{{ oo_network_state }}"

- name: Configure firewall rule - Allow ICMP - "{{ oo_network_state }}"
  gce_net:
    service_account_email: "{{ gce_service_account_email }}"
    pem_file: "{{ gce_pem_file }}"
    project_id: "{{ gce_project_id }}"
    name: "{{ oo_network }}"
    fwname: "{{ oo_network }}-allow-icmp"
    allowed: "icmp"
    state: "{{ oo_network_state }}"

- name: Terminate network
  gce_net:
    service_account_email: "{{ gce_service_account_email }}"
    pem_file: "{{ gce_pem_file }}"
    project_id: "{{ gce_project_id }}"
    name: "{{ oo_network }}"
    ipv4_range: "{{ oo_network_range }}"
    state: "{{ oo_network_state }}"
  when: oo_network_state == "deleted"
